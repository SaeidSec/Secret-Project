# Wazuh App Copyright (C) 2017, Wazuh Inc. (License GPLv2)
services:
  wazuh.master:
    image: wazuh/wazuh-manager:4.14.1
    hostname: wazuh.master
    restart: always
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 655360
        hard: 655360
    expose:
      - "1514"
      - "1515"
      - "55000"
    ports:
      - "514:514/udp"
    environment:
      - INDEXER_URL=https://wazuh.vip:9200
      - INDEXER_USERNAME=admin
      - INDEXER_PASSWORD=SecretPassword
      - FILEBEAT_SSL_VERIFICATION_MODE=full
      - SSL_CERTIFICATE_AUTHORITIES=/etc/ssl/root-ca.pem
      - SSL_CERTIFICATE=/etc/ssl/filebeat.pem
      - SSL_KEY=/etc/ssl/filebeat.key
      - API_USERNAME=wazuh-wui
      - API_PASSWORD=MyS3cr37P450r.*-
    volumes:
      - master-wazuh-api-configuration:/var/ossec/api/configuration
      - master-wazuh-etc:/var/ossec/etc
      - master-wazuh-logs:/var/ossec/logs
      - master-wazuh-queue:/var/ossec/queue
      - master-wazuh-var-multigroups:/var/ossec/var/multigroups
      - master-wazuh-integrations:/var/ossec/integrations
      - master-wazuh-active-response:/var/ossec/active-response/bin
      - master-wazuh-agentless:/var/ossec/agentless
      - master-wazuh-wodles:/var/ossec/wodles
      - master-filebeat-etc:/etc/filebeat
      - master-filebeat-var:/var/lib/filebeat
      - ./config/wazuh_indexer_ssl_certs/root-ca-manager.pem:/etc/ssl/root-ca.pem
      - ./config/wazuh_indexer_ssl_certs/wazuh.master.pem:/etc/ssl/filebeat.pem
      - ./config/wazuh_indexer_ssl_certs/wazuh.master-key.pem:/etc/ssl/filebeat.key
      - ./config/wazuh_cluster/wazuh_manager.conf:/wazuh-config-mount/etc/ossec.conf
      - beelzebub-logs:/var/log/beelzebub:ro
      - cowrie-logs:/var/log/cowrie:ro
      - ./config/wazuh_cluster/beelzebub_rules.xml:/var/ossec/etc/rules/beelzebub_rules.xml:ro
      - ./config/wazuh_cluster/cowrie_rules.xml:/var/ossec/etc/rules/cowrie_rules.xml:ro
      # Trivy Integration
      - ./config/trivy/trivy:/usr/local/bin/trivy:ro
      - ./config/trivy/docker:/usr/bin/docker:ro
      - ./config/trivy/trivy_scan.sh:/var/ossec/custom-script/trivy_scan.sh
      - /var/run/docker.sock:/var/run/docker.sock
      - ./config/trivy/trivy_decoders.xml:/var/ossec/etc/decoders/trivy_decoders.xml:ro
      - ./config/trivy/trivy_rules.xml:/var/ossec/etc/rules/trivy_rules.xml:ro
    networks:
      - wazuh-net
    extra_hosts:
      - "wazuh.vip:172.25.0.222"

  wazuh.worker:
    image: wazuh/wazuh-manager:4.14.1
    hostname: wazuh.worker
    restart: always
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 655360
        hard: 655360
    expose:
      - "1514"
    environment:
      - INDEXER_URL=https://wazuh.vip:9200
      - INDEXER_USERNAME=admin
      - INDEXER_PASSWORD=SecretPassword
      - FILEBEAT_SSL_VERIFICATION_MODE=full
      - SSL_CERTIFICATE_AUTHORITIES=/etc/ssl/root-ca.pem
      - SSL_CERTIFICATE=/etc/ssl/filebeat.pem
      - SSL_KEY=/etc/ssl/filebeat.key
    volumes:
      - worker-wazuh-api-configuration:/var/ossec/api/configuration
      - worker-wazuh-etc:/var/ossec/etc
      - worker-wazuh-logs:/var/ossec/logs
      - worker-wazuh-queue:/var/ossec/queue
      - worker-wazuh-var-multigroups:/var/ossec/var/multigroups
      - worker-wazuh-integrations:/var/ossec/integrations
      - worker-wazuh-active-response:/var/ossec/active-response/bin
      - worker-wazuh-agentless:/var/ossec/agentless
      - worker-wazuh-wodles:/var/ossec/wodles
      - worker-filebeat-etc:/etc/filebeat
      - worker-filebeat-var:/var/lib/filebeat
      - ./config/wazuh_indexer_ssl_certs/root-ca-manager.pem:/etc/ssl/root-ca.pem
      - ./config/wazuh_indexer_ssl_certs/wazuh.worker.pem:/etc/ssl/filebeat.pem
      - ./config/wazuh_indexer_ssl_certs/wazuh.worker-key.pem:/etc/ssl/filebeat.key
      - ./config/wazuh_cluster/wazuh_worker.conf:/wazuh-config-mount/etc/ossec.conf
      - beelzebub-logs:/var/log/beelzebub:ro
      - cowrie-logs:/var/log/cowrie:ro
      - ./config/wazuh_cluster/beelzebub_rules.xml:/var/ossec/etc/rules/beelzebub_rules.xml:ro
      - ./config/wazuh_cluster/cowrie_rules.xml:/var/ossec/etc/rules/cowrie_rules.xml:ro
    networks:
      - wazuh-net
    extra_hosts:
      - "wazuh.vip:172.25.0.222"

  wazuh1.indexer:
    image: wazuh/wazuh-indexer:4.14.1
    hostname: wazuh1.indexer
    restart: always
    expose:
      - "9200"
    environment:
      - "OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g"
      - "bootstrap.memory_lock=true"
      - compatibility.override_main_response_version=false
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - wazuh-indexer-data-1:/var/lib/wazuh-indexer
      - ./config/wazuh_indexer_ssl_certs/root-ca.pem:/usr/share/wazuh-indexer/config/certs/root-ca.pem
      - ./config/wazuh_indexer_ssl_certs/wazuh1.indexer-key.pem:/usr/share/wazuh-indexer/config/certs/wazuh1.indexer.key
      - ./config/wazuh_indexer_ssl_certs/wazuh1.indexer.pem:/usr/share/wazuh-indexer/config/certs/wazuh1.indexer.pem
      - ./config/wazuh_indexer_ssl_certs/admin.pem:/usr/share/wazuh-indexer/config/certs/admin.pem
      - ./config/wazuh_indexer_ssl_certs/admin-key.pem:/usr/share/wazuh-indexer/config/certs/admin-key.pem
      - ./config/wazuh_indexer/wazuh1.indexer.yml:/usr/share/wazuh-indexer/config/opensearch.yml
      - ./config/wazuh_indexer/internal_users.yml:/usr/share/wazuh-indexer/config/opensearch-security/internal_users.yml
    networks:
      - wazuh-net

  wazuh2.indexer:
    image: wazuh/wazuh-indexer:4.14.1
    hostname: wazuh2.indexer
    restart: always
    environment:
      - "OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g"
      - "bootstrap.memory_lock=true"
      - compatibility.override_main_response_version=false
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - wazuh-indexer-data-2:/var/lib/wazuh-indexer
      - ./config/wazuh_indexer_ssl_certs/root-ca.pem:/usr/share/wazuh-indexer/config/certs/root-ca.pem
      - ./config/wazuh_indexer_ssl_certs/wazuh2.indexer-key.pem:/usr/share/wazuh-indexer/config/certs/wazuh2.indexer.key
      - ./config/wazuh_indexer_ssl_certs/wazuh2.indexer.pem:/usr/share/wazuh-indexer/config/certs/wazuh2.indexer.pem
      - ./config/wazuh_indexer/wazuh2.indexer.yml:/usr/share/wazuh-indexer/config/opensearch.yml
      - ./config/wazuh_indexer/internal_users.yml:/usr/share/wazuh-indexer/config/opensearch-security/internal_users.yml
    networks:
      - wazuh-net

  wazuh3.indexer:
    image: wazuh/wazuh-indexer:4.14.1
    hostname: wazuh3.indexer
    restart: always
    environment:
      - "OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g"
      - "bootstrap.memory_lock=true"
      - compatibility.override_main_response_version=false
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - wazuh-indexer-data-3:/var/lib/wazuh-indexer
      - ./config/wazuh_indexer_ssl_certs/root-ca.pem:/usr/share/wazuh-indexer/config/certs/root-ca.pem
      - ./config/wazuh_indexer_ssl_certs/wazuh3.indexer-key.pem:/usr/share/wazuh-indexer/config/certs/wazuh3.indexer.key
      - ./config/wazuh_indexer_ssl_certs/wazuh3.indexer.pem:/usr/share/wazuh-indexer/config/certs/wazuh3.indexer.pem
      - ./config/wazuh_indexer/wazuh3.indexer.yml:/usr/share/wazuh-indexer/config/opensearch.yml
      - ./config/wazuh_indexer/internal_users.yml:/usr/share/wazuh-indexer/config/opensearch-security/internal_users.yml
    networks:
      - wazuh-net

  wazuh.dashboard:
    image: wazuh/wazuh-dashboard:4.14.1
    hostname: wazuh.dashboard
    restart: always
    expose:
      - "5601"
    environment:
      - OPENSEARCH_HOSTS="https://wazuh.vip:9200"
      - WAZUH_API_URL="https://wazuh.vip"
      - API_USERNAME=wazuh-wui
      - API_PASSWORD=MyS3cr37P450r.*-
      - DASHBOARD_USERNAME=kibanaserver
      - DASHBOARD_PASSWORD=kibanaserver
    volumes:
      - ./config/wazuh_indexer_ssl_certs/wazuh.dashboard.pem:/usr/share/wazuh-dashboard/certs/wazuh-dashboard.pem
      - ./config/wazuh_indexer_ssl_certs/wazuh.dashboard-key.pem:/usr/share/wazuh-dashboard/certs/wazuh-dashboard-key.pem
      - ./config/wazuh_indexer_ssl_certs/root-ca.pem:/usr/share/wazuh-dashboard/certs/root-ca.pem
      - ./config/wazuh_dashboard/opensearch_dashboards.yml:/usr/share/wazuh-dashboard/config/opensearch_dashboards.yml
      - ./config/wazuh_dashboard/wazuh.yml:/usr/share/wazuh-dashboard/data/wazuh/config/wazuh.yml
      - wazuh-dashboard-config:/usr/share/wazuh-dashboard/data/wazuh/config
      - wazuh-dashboard-custom:/usr/share/wazuh-dashboard/plugins/wazuh/public/assets/custom
    depends_on:
      - wazuh1.indexer
    links:
      - wazuh1.indexer:wazuh1.indexer
      - wazuh.master:wazuh.master
    networks:
      - wazuh-net
    extra_hosts:
      - "wazuh.vip:172.25.0.222"

  # ============================================================================
  # HA NODE 1 (Pod-like Architecture)
  # ============================================================================
  
  # Network Holder / Pause Container for Node 1
  lb-node-1:
    image: alpine:latest
    hostname: nginx-lb-1
    restart: always
    command: tail -f /dev/null
    ports:
      - "443:443"
      # - "1514:1514" # Port conflicts if on same host, assuming distinct IPs or testing env
      # In single-host docker-compose, we can only bind ports once.
      # Since we want to expose LB1 as the primary entry point via localhost or VIP mapping
      # We map ports here.
      - "1514:1514"
      - "55000:55000"
      - "9200:9200"
      - "3000:3000"
      - "8080:8080"
      - "9090:9090"
      - "10051:10051"
    networks:
      - wazuh-net

  nginx-lb-1:
    image: nginx:stable
    restart: always
    network_mode: "service:lb-node-1"
    depends_on:
      - lb-node-1
      - wazuh.master
      - wazuh.worker
      - wazuh.dashboard
      - wazuh1.indexer
      - wazuh2.indexer
      - wazuh3.indexer
      - grafana
      - zabbix-web
      - prometheus
      - zabbix-server
    volumes:
      - ./config/nginx/nginx_ha.conf:/etc/nginx/nginx.conf:ro
      - nginx-lb-1-logs:/var/log/nginx

  telegraf-lb-1:
    image: telegraf:alpine
    restart: always
    network_mode: "service:lb-node-1"
    depends_on:
      - nginx-lb-1
    volumes:
      - ./config/telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro
      - nginx-lb-1-logs:/var/log/nginx:ro

  # ============================================================================
  # HA NODE 2 (Pod-like Architecture)
  # ============================================================================

  # Network Holder / Pause Container for Node 2
  lb-node-2:
    image: alpine:latest
    hostname: nginx-lb-2
    restart: always
    command: tail -f /dev/null
    # No ports mapped for backup node on single host to avoid conflicts
    networks:
      - wazuh-net

  nginx-lb-2:
    image: nginx:stable
    restart: always
    network_mode: "service:lb-node-2"
    depends_on:
      - lb-node-2
      - wazuh.master
      - wazuh.worker
      - wazuh.dashboard
      - wazuh1.indexer
      - wazuh2.indexer
      - wazuh3.indexer
      - grafana
      - zabbix-web
      - prometheus
      - zabbix-server
    volumes:
      - ./config/nginx/nginx_ha.conf:/etc/nginx/nginx.conf:ro
      - nginx-lb-2-logs:/var/log/nginx

  telegraf-lb-2:
    image: telegraf:alpine
    restart: always
    network_mode: "service:lb-node-2"
    depends_on:
      - nginx-lb-2
    volumes:
      - ./config/telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro
      - nginx-lb-2-logs:/var/log/nginx:ro

  keepalived-1:
    image: osixia/keepalived:2.0.20
    container_name: keepalived-1
    restart: always
    network_mode: "service:lb-node-1"
    cap_add:
      - NET_ADMIN
      - NET_BROADCAST
      - NET_RAW
    volumes:
      - ./config/keepalived/master.conf:/usr/local/etc/keepalived/keepalived.conf:ro

  keepalived-2:
    image: osixia/keepalived:2.0.20
    container_name: keepalived-2
    restart: always
    network_mode: "service:lb-node-2"
    cap_add:
      - NET_ADMIN
      - NET_BROADCAST
      - NET_RAW
    volumes:
      - ./config/keepalived/backup.conf:/usr/local/etc/keepalived/keepalived.conf:ro

  # Zabbix PostgreSQL Database
  zabbix-postgres:
    image: postgres:16-alpine
    hostname: zabbix-postgres
    restart: always
    environment:
      - POSTGRES_USER=zabbix
      - POSTGRES_PASSWORD=zabbix_password
      - POSTGRES_DB=zabbix
    volumes:
      - zabbix-postgres-data:/var/lib/postgresql/data
    networks:
      - wazuh-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U zabbix"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Zabbix Server
  zabbix-server:
    image: zabbix/zabbix-server-pgsql:alpine-7.0-latest
    hostname: zabbix-server
    restart: always
    expose:
      - "10051"
    environment:
      - DB_SERVER_HOST=zabbix-postgres
      - POSTGRES_USER=zabbix
      - POSTGRES_PASSWORD=zabbix_password
      - POSTGRES_DB=zabbix
      - ZBX_ENABLE_SNMP_TRAPS=true
      - ZBX_STARTPOLLERS=5
      - ZBX_STARTPOLLERSUNREACHABLE=1
      - ZBX_STARTTRAPPERS=5
      - ZBX_STARTPINGERS=1
      - ZBX_STARTDISCOVERERS=1
      - ZBX_STARTHTTPPOLLERS=1
    volumes:
      - zabbix-server-data:/var/lib/zabbix
    depends_on:
      - zabbix-postgres
    networks:
      - wazuh-net

  # Zabbix Web Frontend
  zabbix-web:
    image: zabbix/zabbix-web-nginx-pgsql:alpine-7.0-latest
    hostname: zabbix-web
    restart: always
    expose:
      - "8080"
    environment:
      - DB_SERVER_HOST=zabbix-postgres
      - POSTGRES_USER=zabbix
      - POSTGRES_PASSWORD=zabbix_password
      - POSTGRES_DB=zabbix
      - ZBX_SERVER_HOST=zabbix-server
      - ZBX_SERVER_PORT=10051
      - PHP_TZ=Asia/Dhaka
    depends_on:
      - zabbix-server
      - zabbix-postgres
    networks:
      - wazuh-net

  # Zabbix Agent for Wazuh Master
  zabbix-agent-master:
    image: zabbix/zabbix-agent2:alpine-7.0-latest
    restart: always
    privileged: true
    network_mode: "service:wazuh.master"
    environment:
      - ZBX_HOSTNAME=wazuh.master
      - ZBX_SERVER_HOST=zabbix-server
      - ZBX_SERVER_PORT=10051
      - ZBX_PASSIVE_ALLOW=true
      - ZBX_ACTIVE_ALLOW=true
    depends_on:
      - zabbix-server

  # Zabbix Agent for Wazuh Worker
  zabbix-agent-worker:
    image: zabbix/zabbix-agent2:alpine-7.0-latest
    restart: always
    privileged: true
    network_mode: "service:wazuh.worker"
    environment:
      - ZBX_HOSTNAME=wazuh.worker
      - ZBX_SERVER_HOST=zabbix-server
      - ZBX_SERVER_PORT=10051
      - ZBX_PASSIVE_ALLOW=true
      - ZBX_ACTIVE_ALLOW=true
    depends_on:
      - zabbix-server

  # Zabbix Agent for Indexer 1
  zabbix-agent-indexer1:
    image: zabbix/zabbix-agent2:alpine-7.0-latest
    restart: always
    privileged: true
    network_mode: "service:wazuh1.indexer"
    environment:
      - ZBX_HOSTNAME=wazuh1.indexer
      - ZBX_SERVER_HOST=zabbix-server
      - ZBX_SERVER_PORT=10051
      - ZBX_PASSIVE_ALLOW=true
      - ZBX_ACTIVE_ALLOW=true
    depends_on:
      - zabbix-server

  # Zabbix Agent for Indexer 2
  zabbix-agent-indexer2:
    image: zabbix/zabbix-agent2:alpine-7.0-latest
    restart: always
    privileged: true
    network_mode: "service:wazuh2.indexer"
    environment:
      - ZBX_HOSTNAME=wazuh2.indexer
      - ZBX_SERVER_HOST=zabbix-server
      - ZBX_SERVER_PORT=10051
      - ZBX_PASSIVE_ALLOW=true
      - ZBX_ACTIVE_ALLOW=true
    depends_on:
      - zabbix-server

  # Zabbix Agent for Indexer 3
  zabbix-agent-indexer3:
    image: zabbix/zabbix-agent2:alpine-7.0-latest
    restart: always
    privileged: true
    network_mode: "service:wazuh3.indexer"
    environment:
      - ZBX_HOSTNAME=wazuh3.indexer
      - ZBX_SERVER_HOST=zabbix-server
      - ZBX_SERVER_PORT=10051
      - ZBX_PASSIVE_ALLOW=true
      - ZBX_ACTIVE_ALLOW=true
    depends_on:
      - zabbix-server

  # Zabbix Agent for Dashboard
  zabbix-agent-dashboard:
    image: zabbix/zabbix-agent2:alpine-7.0-latest
    restart: always
    privileged: true
    network_mode: "service:wazuh.dashboard"
    environment:
      - ZBX_HOSTNAME=wazuh.dashboard
      - ZBX_SERVER_HOST=zabbix-server
      - ZBX_SERVER_PORT=10051
      - ZBX_PASSIVE_ALLOW=true
      - ZBX_ACTIVE_ALLOW=true
    depends_on:
      - zabbix-server

  # Zabbix Agent for Nginx LB 1
  zabbix-agent-nginx-lb-1:
    image: zabbix/zabbix-agent2:alpine-7.0-latest
    restart: always
    privileged: true
    network_mode: "service:lb-node-1"
    environment:
      - ZBX_HOSTNAME=nginx-lb-1
      - ZBX_SERVER_HOST=zabbix-server
      - ZBX_SERVER_PORT=10051
      - ZBX_PASSIVE_ALLOW=true
      - ZBX_ACTIVE_ALLOW=true
    depends_on:
      - zabbix-server

  # Zabbix Agent for Nginx LB 2
  zabbix-agent-nginx-lb-2:
    image: zabbix/zabbix-agent2:alpine-7.0-latest
    restart: always
    privileged: true
    network_mode: "service:lb-node-2"
    environment:
      - ZBX_HOSTNAME=nginx-lb-2
      - ZBX_SERVER_HOST=zabbix-server
      - ZBX_SERVER_PORT=10051
      - ZBX_PASSIVE_ALLOW=true
      - ZBX_ACTIVE_ALLOW=true
    depends_on:
      - zabbix-server

  # Zabbix Agent for Grafana
  zabbix-agent-grafana:
    image: zabbix/zabbix-agent2:alpine-7.0-latest
    restart: always
    privileged: true
    network_mode: "service:grafana"
    environment:
      - ZBX_HOSTNAME=grafana
      - ZBX_SERVER_HOST=zabbix-server
      - ZBX_SERVER_PORT=10051
      - ZBX_PASSIVE_ALLOW=true
      - ZBX_ACTIVE_ALLOW=true
    depends_on:
      - zabbix-server

  # Zabbix Agent for Zabbix Postgres
  zabbix-agent-postgres:
    image: zabbix/zabbix-agent2:alpine-7.0-latest
    restart: always
    privileged: true
    network_mode: "service:zabbix-postgres"
    environment:
      - ZBX_HOSTNAME=zabbix-postgres
      - ZBX_SERVER_HOST=zabbix-server
      - ZBX_SERVER_PORT=10051
      - ZBX_PASSIVE_ALLOW=true
      - ZBX_ACTIVE_ALLOW=true
    depends_on:
      - zabbix-server

  # Grafana
  grafana:
    image: grafana/grafana:latest
    hostname: grafana
    restart: always
    expose:
      - "3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_INSTALL_PLUGINS=grafana-opensearch-datasource,alexanderzobnin-zabbix-app
      - GF_PLUGINS_ALLOW_LOADING_UNSIGNED_PLUGINS=alexanderzobnin-zabbix-datasource
      - GF_SERVER_ROOT_URL=http://172.25.0.222:3000
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana-data:/var/lib/grafana
      - ./config/grafana/provisioning:/etc/grafana/provisioning
      - ./config/grafana/dashboards:/etc/grafana/dashboards
    depends_on:
      - zabbix-server
      - wazuh1.indexer
      - prometheus
    networks:
      - wazuh-net

  # cAdvisor - Docker Container Metrics
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    hostname: cadvisor
    restart: always
    privileged: true
    expose:
      - "8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    networks:
      - wazuh-net

  # Node Exporter - Host Metrics
  node-exporter:
    image: prom/node-exporter:latest
    hostname: node-exporter
    restart: always
    expose:
      - "9100"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.rootfs=/rootfs'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    networks:
      - wazuh-net

  # Prometheus - Metrics Collection
  prometheus:
    image: prom/prometheus:latest
    hostname: prometheus
    restart: always
    expose:
      - "9090"
    volumes:
      - ./config/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    depends_on:
      - cadvisor
      - node-exporter
    networks:
      - wazuh-net

  # Beelzebub Honeypot
  beelzebub:
    image: m4r10/beelzebub:latest
    hostname: beelzebub
    restart: always
    ports:
      - "2222:22"
      - "8000:80"
    volumes:
      - ./config/beelzebub:/configurations:ro
      - beelzebub-logs:/var/log/beelzebub
    networks:
      - wazuh-net

  # Zabbix Agent for Beelzebub
  zabbix-agent-beelzebub:
    image: zabbix/zabbix-agent2:alpine-7.0-latest
    restart: always
    privileged: true
    network_mode: "service:beelzebub"
    environment:
      - ZBX_HOSTNAME=beelzebub
      - ZBX_SERVER_HOST=zabbix-server
      - ZBX_SERVER_PORT=10051
      - ZBX_PASSIVE_ALLOW=true
      - ZBX_ACTIVE_ALLOW=true
    depends_on:
      - zabbix-server

  # Cowrie Honeypot
  cowrie:
    image: cowrie/cowrie:latest
    hostname: cowrie
    restart: always
    ports:
      - "2223:2222"
    volumes:
      - ./config/cowrie/cowrie.cfg:/cowrie/cowrie-git/cowrie.cfg:ro
      - cowrie-logs:/cowrie/cowrie-git/var/log/cowrie
    networks:
      - wazuh-net

  # Zabbix Agent for Cowrie
  zabbix-agent-cowrie:
    image: zabbix/zabbix-agent2:alpine-7.0-latest
    restart: always
    privileged: true
    network_mode: "service:cowrie"
    environment:
      - ZBX_HOSTNAME=cowrie
      - ZBX_SERVER_HOST=zabbix-server
      - ZBX_SERVER_PORT=10051
      - ZBX_PASSIVE_ALLOW=true
      - ZBX_ACTIVE_ALLOW=true
    depends_on:
      - zabbix-server

  # MongoDB for Graylog
  mongodb:
    image: mongo:7.0
    hostname: mongodb
    restart: always
    volumes:
      - mongodb_data:/data/db
    networks:
      - wazuh-net

  # Graylog 7.0.3
  graylog:
    image: graylog/graylog:7.0
    hostname: graylog
    restart: always
    environment:
      - GRAYLOG_NODE_ID_FILE=/usr/share/graylog/data/config/node-id
      - GRAYLOG_PASSWORD_SECRET=somepasswordpepper1234567890
      - GRAYLOG_ROOT_PASSWORD_SHA2=8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918
      - GRAYLOG_HTTP_BIND_ADDRESS=0.0.0.0:9000
      - GRAYLOG_HTTP_EXTERNAL_URI=http://127.0.0.1:9000/
      - GRAYLOG_MONGODB_URI=mongodb://mongodb:27017/graylog
      - GRAYLOG_ELASTICSEARCH_HOSTS=https://admin:SecretPassword@wazuh1.indexer:9200,https://admin:SecretPassword@wazuh2.indexer:9200,https://admin:SecretPassword@wazuh3.indexer:9200
      - GRAYLOG_ELASTICSEARCH_RETRY_ON_TIMEOUT=true
      - GRAYLOG_ELASTICSEARCH_MAX_TOTAL_CONNECTIONS=200
      - GRAYLOG_ELASTICSEARCH_SSL_VERIFICATION_MODE=none
      # Use custom truststore for SSL
      - GRAYLOG_SERVER_JAVA_OPTS=-Djavax.net.ssl.trustStore=/usr/share/graylog/data/config/truststore.jks -Djavax.net.ssl.trustStorePassword=changeit
    ports:
      - "9000:9000"
      - "12201:12201/udp"
      - "12201:12201/tcp"
      - "1515:1515/udp"
      - "1515:1515/tcp"
    volumes:
      - graylog_data:/usr/share/graylog/data/data
      - graylog_journal:/usr/share/graylog/data/journal
      - ./config/wazuh_indexer_ssl_certs/root-ca.pem:/usr/share/graylog/data/config/root-ca.pem:ro
      - ./config/graylog/truststore.jks:/usr/share/graylog/data/config/truststore.jks:ro
    depends_on:
      - mongodb
      - wazuh1.indexer
      - wazuh2.indexer
      - wazuh3.indexer
    networks:
      - wazuh-net

  # Zabbix Agent for Graylog
  zabbix-agent-graylog:
    image: zabbix/zabbix-agent2:alpine-7.0-latest
    restart: always
    privileged: true
    network_mode: "service:graylog"
    environment:
      - ZBX_HOSTNAME=graylog
      - ZBX_SERVER_HOST=zabbix-server
      - ZBX_SERVER_PORT=10051
      - ZBX_PASSIVE_ALLOW=true
      - ZBX_ACTIVE_ALLOW=true



volumes:
  mongodb_data:
  graylog_data:
  graylog_journal:
  beelzebub-logs:
  cowrie-logs:
  master-wazuh-api-configuration:
  master-wazuh-etc:
  master-wazuh-logs:
  master-wazuh-queue:
  master-wazuh-var-multigroups:
  master-wazuh-integrations:
  master-wazuh-active-response:
  master-wazuh-agentless:
  master-wazuh-wodles:
  master-filebeat-etc:
  master-filebeat-var:
  worker-wazuh-api-configuration:
  worker-wazuh-etc:
  worker-wazuh-logs:
  worker-wazuh-queue:
  worker-wazuh-var-multigroups:
  worker-wazuh-integrations:
  worker-wazuh-active-response:
  worker-wazuh-agentless:
  worker-wazuh-wodles:
  worker-filebeat-etc:
  worker-filebeat-var:
  wazuh-indexer-data-1:
  wazuh-indexer-data-2:
  wazuh-indexer-data-3:
  wazuh-dashboard-config:
  wazuh-dashboard-custom:
  zabbix-postgres-data:
  zabbix-server-data:
  grafana-data:
  prometheus-data:
  nginx-lb-1-logs:
  nginx-lb-2-logs:

networks:
  wazuh-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16
